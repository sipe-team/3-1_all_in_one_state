# 2024년 TanStack Query에서 다룬 큰 Issue, Discussion, PR 5개를 다뤄보자.

## [Query that is not enabled returns the result stored in the cache #7630](https://github.com/TanStack/query/issues/7630)

위 이슈는 useQuery에서 `enabled: false`로 설정했을 때도 캐시에 저장된 데이터가 반환되는 현상이다. 이를 통해 페이지 간 이동시 예기치 못한 동작이 유발되어 작성되었다.

우선 enabled 옵션에 대해서 알아보자.

enabled 옵션은 false일 때 쿼리의 실행(fetch)만을 중지하고, 캐시 구독(subscription)은 계속 유지된다. 만약 캐시에 데이터가 있다면 `enabled: false`여도 데이터 반환하고, 캐시 업데이트가 발생하면 컴포넌트 리렌더링 발생한다.

### 그럼 어떤것이 문제인가?

이슈 작성자는 `enabled : false`는 완전한 비활성화를 의미한다고 생각한다.

그렇기에 캐시된 데이터도 반환하지 않아야 하는데, 지금 동작은 직관적이지 않고, 잘못된 데이터 표시라고 생각함

### maintainer의 답변

TkDodo가 등장했다.

> query는 캐시 기반 상태 관리 도구다. 
>
> useQuery는 어떠한 상황에도 캐시 엔트리를 구독하도록 되어있다.
>
> enabled는 단순한 fetch 사이클만 제어한다. (fetch 제어용이지, 캐시 제어용이 아님)
>
> 그렇기에 mutation, setQueryData로 캐시가 업데이트되면 반영되어야한다.

그러고 효율적으로 사용하는 방법에 가이드해주었다.

#### 완전한 데이터 제어가 필요하면 아래와 같이 컴포넌트 구조를 재설계

filter와 query 분리를 제안 => 이슈에서 제시해준 코드가 filter 관련이다.


```ts
function ParentComponent() {
  const [filter, setFilter] = useState('')
  
  return filter ? <DataComponent filter={filter} /> : null
}

function DataComponent({ filter }) {
  const { data } = useQuery({
    queryKey: ['data', filter],
    queryFn: () => fetchData(filter)
  })
}
```

#### 조건부 렌더링을 사용하면 더 예측이 가능하다

```ts
function Component() {
  const { data } = useQuery({
    queryKey: ['data', filter],
    queryFn: () => fetchData(filter),
    enabled: !!filter
  })

  if (!filter) {
    return <EmptyState />
  }

  return <DataView data={data} />
}
```

### 결론

문제없음. => "works as designed" ㅋㅋ

라이브러리의 의도된 동작이므로 변경 계획 없음으로, 사용자들은 이 동작을 이해하고 적절한 패턴을 사용해야 함(문서를 잘 읽어라.)

올해 최상의 Issue가 된 이유가 뭘까? 치명적인 오류가 아닌데.. maybe? 대부분의 사람들이 enabled를 사용할때 fetch, cache에 대해 잘 몰라서라고 생각!

## 주제2