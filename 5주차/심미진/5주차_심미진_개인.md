# Query Key ì„¤ê³„ ì „ëµê³¼ ì»¨ë²¤ì…˜

Query KeysëŠ” React Queryì—ì„œ ì•„ì£¼ ì¤‘ìš”í•œ í•µì‹¬ ê°œë….

queryKey ë•ë¶„ì— ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ìºì‹±, queryKey dependencyê°€ ë³€ê²½ë  ë•Œ ìë™ìœ¼ë¡œ refetch ê°€ëŠ¥í•¨.

ë˜í•œ mutations í›„ ìˆ˜ë™ìœ¼ë¡œ ì¿¼ë¦¬ ë¬´íš¨í™”(invalidate)ë¥¼ í•˜ê¸°ìœ„í•´ í•„ìš”í•˜ë‹¤.

# queryKey ê´€ë ¨ ê¸°ëŠ¥

## ë°ì´í„° ìºì‹±

ë‚´ë¶€ì ìœ¼ë¡œ Query ìºì‹œëŠ” javascript ê°ì²´.

key: ì§ë ¬í™”ëœ queryKey, value: Query data ì™€ ë©”íƒ€ ì •ë³´

queryKeyëŠ” ë°°ì—´ [ ] í˜•íƒœì´ë©° ë°°ì—´ì˜ ì›ì†ŒëŠ” string, objectë“±ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤.

ì›ì†Œë“¤ì˜ ìˆœì„œê°€ ë‹¤ë¥´ë©´ ì„œë¡œ ë‹¤ë¥¸ keyë¡œ ì¸ì‹ëœë‹¤. (['todos', 'kuma'] ì™€ ['kuma', 'todos'] ëŠ” ì„œë¡œ ë‹¤ë¥´ê²Œ ì·¨ê¸‰ëœë‹¤)

ë‹¤ë§Œ ì›ì†Œê°€ ê°ì²´ì¼ë•Œ, í•´ë‹¹ ê°ì²´ ë‚´ë¶€ keyì˜ ìˆœì„œê°€ ë‹¬ë¼ì ¸ë„ ê°™ì€ ì¿¼ë¦¬ë¡œ ê°„ì£¼ëœë‹¤.

```javascript
// ì¿¼ë¦¬ 1
useQuery({
  queryKey: ["todos", { status: "completed", page: 1 }],
  queryFn: fetchTodos,
});

// ì¿¼ë¦¬ 2
useQuery({
  queryKey: ["todos", { page: 1, status: "completed" }],
  queryFn: fetchTodos,
});

// ë‘ ì¿¼ë¦¬ëŠ” ê°™ë‹¤
```

ë‹¤ë§Œ keyëŠ” ê°™ë”ë¼ë„ valueê°€ ë‹¬ë¼ì§€ë§Œ ë‹¤ë¥¸ ì¿¼ë¦¬ì´ë‹¤.

```javascript
// ì¿¼ë¦¬ 1
useQuery({
  queryKey: ["todos", { status: "completed", page: 1 }],
  queryFn: fetchTodos,
});

// ì¿¼ë¦¬ 2
useQuery({
  queryKey: ["todos", { status: "pending", page: 1 }],
  queryFn: fetchTodos,
});

// ë‘ ì¿¼ë¦¬ëŠ” ë‹¤ë¥´ë‹¤.
```

ë˜í•œ React Queryê°€ ìºì‹œ ëª©ë¡ì—ì„œ queryKeyì— ëŒ€ì‘í•˜ëŠ” valueë¥¼ ì°¾ìœ¼ë©´ ì´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—,

queryKeyëŠ” ë°˜ë“œì‹œ unique í•´ì•¼í•œë‹¤.

ë˜í•œ useQuery ì™€ useInfiniteQueryì— ë™ì¼í•œ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

```javascript
useQuery({
  queryKey: ["todos"],
  queryFn: fetchTodos,
});

// ğŸš¨ useQueryì™€ queryKeyê°€ ë™ì¼í•˜ê¸° ë•Œë¬¸ì— ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.
useInfiniteQuery({
  queryKey: ["todos"],
  queryFn: fetchInfiniteTodos,
});

// âœ… ë‹¤ë¥¸ queryKeyë¥¼ ì„ ì–¸í•˜ì.
useInfiniteQuery({
  queryKey: ["infiniteTodos"],
  queryFn: fetchInfiniteTodos,
});
```

## ìë™ Refetch

ì¿¼ë¦¬ëŠ” ì„ ì–¸ì ì´ë‹¤.

ëŒ€ë¶€ë¶„ì˜ ì‚¬ëŒë“¤ì€ ì¿¼ë¦¬ë¥¼ ìƒê°í• ë•Œ, íŠ¹íˆ refetchingì„ í• ë•Œ ëª…ë ¹ì ìœ¼ë¡œ ìƒê°í•œë‹¤.

ê¸°ì¡´ ì¿¼ë¦¬ê°€ ìˆì„ë•Œ í•„í„° ì¡°ê±´ì„ ê±¸ ìˆ˜ ìˆì„ë•Œ ì´ëŸ°ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆë‹¤.

```javascript

function Component() {
const { data, refetch } = useQuery({
queryKey: ['todos'],
queryFn: fetchTodos,
})

// â“ ë§¤ê°œë³€ìˆ˜ë¥¼ ë„˜ê¸°ê³  ì‹¶ì€ë°.. â“
return <Filters onApply={() => refetch(???)} />
}

```

í•˜ì§€ë§Œ ì´ë ‡ê²Œ í•˜ë©´ ì•ˆëœë‹¤.

ì´ëŠ” refetchì˜ ì¡´ì¬ ëª©ì ì´ ì•„ë‹ˆë‹¤.(refetchì˜ ëª©ì ì€ ê°™ì€ ë§¤ê°œë³€ìˆ˜ë¡œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒ)

ë§Œì•½ í•„í„°ì™€ ê°™ì´ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ìƒíƒœê°€ ìˆëŠ” ê²½ìš°, queryKeyê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ React Queryê°€ ìë™ìœ¼ë¡œ refetch í•˜ë¯€ë¡œ, í•´ë‹¹ ìƒíƒœë¥¼ queryKeyì— ë„£ê¸°ë§Œ í•˜ë©´ ëœë‹¤.

ì¦‰ ì¿¼ë¦¬ì— í•„í„°ë¥¼ ì ìš©í•˜ê³  ì‹¶ë‹¤ë©´ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¥¼ ë³€ê²½í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.

```javascript
function Component() {
  const [filters, setFilters] = React.useState();
  const { data } = useQuery({
    queryKey: ["todos", filters],
    queryFn: () => fetchTodos(filters),
  });

  // âœ… ë¡œì»¬ ìƒíƒœë¥¼ setí•˜ì—¬ queryë¥¼ ê°€ì ¸ì˜¤ì.
  return <Filters onApply={setFilters} />;
}
```

setFilters í˜¸ì¶œì„ í†µí•´ ë¦¬ë Œë”ë§ì´ ë˜ë©´ ë‹¤ë¥¸ filters(queryKey)ê°€ ì¿¼ë¦¬ì— ì „ë‹¬ë˜ì–´ dataê°€ refetch ëœë‹¤.

ë”°ë¼ì„œ ì„ ì–¸ì ìœ¼ë¡œ refetchê°€ ë˜ëŠ” ê²ƒì´ë‹¤.

## Manual Interaction (ìˆ˜ë™ ìƒí˜¸ì‘ìš©)

invalidateQueries ë‚˜ setQueriesData ê°™ì´ ê°œë°œìê°€ ìˆ˜ë™ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œëŠ” í˜¸ì¶œí•  ë•Œ Query Flitersë¥¼ ë„£ì–´ì¤˜ì•¼í•œë‹¤.

Query Filtersì—ëŠ” ì¡°ì‘í•  ì¿¼ë¦¬ë¥¼ íŠ¹ì •í•˜ê¸°ìœ„í•´ queryKeyê°€ ì´ìš©ëœë‹¤.

```javascript
// ì²« ì›ì†Œê°€ postsë¡œ ì‹œì‘í•˜ëŠ” queryKeyë¥¼ ê°€ì§„ ëª¨ë“  inactive ì¿¼ë¦¬ë“¤ì„ ì œê±°í•œë‹¤.
queryClient.removeQueries({ queryKey: ["posts"], type: "inactive" });
```

# íš¨ê³¼ì ì¸ React Query Keys

## Colocate
   ì°¸ê³ ) Kent C. Doddsì˜ Maintainability through colocation

ëª¨ë“  queryKeyë¥¼ /src/utils/queryKeys.tsì— ì „ì—­ì ìœ¼ë¡œ ë°°ì¹˜í•˜ëŠ”ê²Œ ì¢‹ì„ê¹Œ?

```text
- src
  - features
    - Profile
      - index.tsx
      - queries.ts
    - Todos
      - index.tsx
      - queries.ts
```

ë‹¤ìŒê³¼ ê°™ì´ í›…ì´ ê°€ê¹Œì´ ì“°ì´ëŠ” í´ë”ì— fetch, useQuery, queryKeyë¥¼ ê°™ì€ íŒŒì¼ì— í•¨ê»˜ ì„ ì–¸í•´ë³´ì.

ë³´í†µ useQueryë¥¼ ê°ì‹¸ëŠ” ì»¤ìŠ¤í…€í›…ì„ ë‚´ë³´ë‚´ê³ , queryKeyë„ í•„ìš”í•˜ë‹¤ë©´ ê·¸ë•Œ ë‚´ë³´ë‚¸ë‹¤.

- ì¶”ê°€

queryKeyëŠ” ê´€ë ¨ëœ ê¸°ëŠ¥ì˜ ê³µí†µ ë¶€ëª¨ í´ë”ì— í•˜ë‚˜ì˜ ê°ì²´ë¡œ ì„ ì–¸í•´ë‘ëŠ”ê²Œ ì¢‹ì•„ë³´ì¸ë‹¤.

=> ì¿¼ë¦¬ í‚¤ íŒ©í† ë¦¬ ì‚¬ìš©

## queryKey ë°°ì—´ ì›ì†Œ ì„ ì–¸ ìˆœì„œ
ì¼ë°˜ì ì¸ key -> êµ¬ì²´ì ì¸ key ìˆœì„œëŒ€ë¡œ ì„ ì–¸

ë‹¤ìŒì€ í•„í„°ë§ ê°€ëŠ¥í•œ listì™€ ê° itemë³„ ìƒì„¸ ë³´ê¸°ê°€ ê°€ëŠ¥í•œ íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ì˜ queryKey ì˜ˆì‹œì´ë‹¤.


```javascript
['todos', 'list', { filters: 'all' }]
['todos', 'list', { filters: 'done' }]
['todos', 'detail', 1]
['todos', 'detail', 2]
```


ì´ë ‡ê²Œ ì„ ì–¸í•˜ë©´ ['todos']ì™€ ê´€ë ¨ëœ ëª¨ë“  ì¿¼ë¦¬ë¥¼ ë¬´íš¨í™”í•  ìˆ˜ ìˆê³ , ì •í™•í•œ queryKeyë¥¼ ì•Œê³ ìˆë‹¤ë©´ íŠ¹ì • ì¿¼ë¦¬ í•˜ë‚˜ë¥¼ íƒ€ê²ŸíŒ…í•  ìˆ˜ ìˆë‹¤.

ë˜í•œ mutation ê²°ê³¼(onSuccess, onErrorì—ì„œ)ì— ë”°ë¼ ì¿¼ë¦¬ë¥¼ ì—…ë°ì´íŠ¸ í•  ìˆ˜ ìˆë‹¤.

```javascript

// mutation ê²°ê³¼ì— ë”°ë¼ query ì—…ë°ì´íŠ¸ í•˜ê¸°.
function useUpdateTitle() {
return useMutation({
mutationFn: updateTitle,
onSuccess: (newTodo) => {
// âœ… ['todos', 'detail', newTodo.id]ì¸ ìºì‹œ ì—…ë°ì´íŠ¸
queryClient.setQueryData(
['todos', 'detail', newTodo.id],
newTodo
)

      // âœ…['todos', 'list'] ìºì‹œ ë‚´ë¶€ì— ìˆëŠ” todo.idì— í•´ë‹¹í•˜ëŠ” todo ì—…ë°ì´íŠ¸
      queryClient.setQueriesData(['todos', 'list'], (previous) =>
        previous.map((todo) =>
          todo.id === newTodo.id ? newtodo : todo
        )
      )
    },

})
}

```


í•˜ì§€ë§Œ ìœ„ ë°©ë²•ì€ ë³µì¡í•˜ê³ , listì™€ detailì˜ todo í˜•ì‹ì´ ë§ì´ ë‹¤ë¥¸ ê²½ìš°ì—ëŠ” ì ìš©í•˜ê¸° ê¹Œë‹¤ë¡œìš¸ ìˆ˜ ìˆë‹¤.

ëŒ€ì‹  ëª¨ë“  ['todos'] ìºì‹œë¥¼ ë¬´íš¨í™”í•˜ëŠ” ë°©ë²•ì´ ìˆë‹¤. (ì„œë²„ì— ì¬ìš”ì²­)

```javascript

// ìºì‹œ ë¬´íš¨í™” í•˜ê¸°.
function useUpdateTitle() {
return useMutation({
mutationFn: updateTitle,
onSuccess: (newTodo) => {
queryClient.setQueryData(
['todos', 'detail', newTodo.id],
newTodo
)

      // âœ… ['todos', 'list'] ìºì‹œ ë¬´íš¨í™”
      queryClient.invalidateQueries({
        queryKey: ['todos', 'list']
      })
    },

})
}

```

URLì—ì„œ í•„í„°ë¥¼ ì½ëŠ” ë“±ì˜ ë°©ì‹ìœ¼ë¡œ queryKey ë¥¼ êµ¬ì„±í•˜ì—¬ setQueryDataë¥¼ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆë‹¤.

```javascript

function useUpdateTitle() {
// imagine a custom hook that returns
// the current filters, stored in the url
const { filters } = useFilterParams()

return useMutation({
mutationFn: updateTitle,
onSuccess: (newTodo) => {
queryClient.setQueryData(
['todos', 'detail', newTodo.id],
newTodo
)

      // í˜„ì¬ ìœ„ì¹˜í•œ list ì—…ë°ì´íŠ¸
      queryClient.setQueryData(
        ['todos', 'list', { filters }],
        (previous) =>
          previous.map((todo) =>
            todo.id === newTodo.id ? newtodo : todo
          )
      )

      // ëª¨ë“  list ë¬´íš¨í™”
      // ë‹¤ë§Œ activeì¸ listëŠ” refetch í•˜ì§€ ì•ŠëŠ”ë‹¤ (refetchType: 'none')
      queryClient.invalidateQueries({
        queryKey: ['todos', 'list'],
        refetchType: 'none',
      })
    },

})
}

```

## ì¿¼ë¦¬ í‚¤ íŒ©í† ë¦¬ ì‚¬ìš©í•˜ê¸°
ìœ„ ì˜ˆì œì—ì„œëŠ” queryKeyë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„ ì–¸í•´ë‘ì—ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ ë” ì„¸ë¶€ì ì¸ keyë¥¼ ì¶”ê°€í•˜ëŠ” ê²½ìš°ì™€ ê°™ì´ ë³€ê²½í•˜ê¸°ê°€ ì—¬ëŸ¬ì›Œì§„ë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ ì–´ë–¤ ê¸°ëŠ¥ê³¼ ê´€ë ¨ëœ queryKey ë“¤ì€ ê°ì²´ í•˜ë‚˜ì— ëª¨ë‘ ëª¨ì•„ë‘ì.

```javascript

const todoKeys = {
all: ['todos'] as const,
lists: () => [...todoKeys.all, 'list'] as const,
list: (filters: string) => [...todoKeys.lists(), { filters }] as const,
details: () => [...todoKeys.all, 'detail'] as const,
detail: (id: number) => [...todoKeys.details(), id] as const,
}

```

ìœ ì—°í•˜ê³  ë…ë¦½ì ìœ¼ë¡œ í‚¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

```javascript

// todoì™€ ê´€ë ¨ëœ ëª¨ë“  ì¿¼ë¦¬ë¥¼ ì œê±°í•œë‹¤.
queryClient.removeQueries({
queryKey: todoKeys.all
})

// ëª¨ë“  todo listë¥¼ ë¬´íš¨í™”í•œë‹¤.
queryClient.invalidateQueries({
queryKey: todoKeys.lists()
})

// íŠ¹ì • todo í•˜ë‚˜ë¥¼ prefetch í•œë‹¤.
queryClient.prefetchQueries({
queryKey: todoKeys.detail(id),
queryFn: () => fetchTodo(id),
})

```

ê° ê¸°ëŠ¥ë³„ë¡œ ì¿¼ë¦¬ í‚¤ë¥¼ ì„ ì–¸í•´ë‘ë©´ ì„œë²„ ìƒíƒœë¡œ í•œëˆˆì— ë³´ê¸° ì‰¬ìš´ ì¥ì ì´ ìˆì„ ê²ƒ ê°™ë‹¤.

# ì°¸ê³ ìë£Œ
https://tkdodo.eu/blog/effective-react-query-keys
